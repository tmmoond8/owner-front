<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>owwners</title>
</head>
<body>
  <h2>Kakao Login Page</h2>
  <p id="locationHref"></p>
  <p id="uuid">uuid</p>
  <p id="code">code</p>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js" integrity="sha512-nOQuvD9nKirvxDdvQ9OMqe2dgapbPB7vYAMrzJihw5m+aNcf0dX53m6YxM4LgA9u8e9eg9QX+/+mPu8kCNpV2A==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
  <script>
    const locationHref = document.querySelector('#locationHref');
    locationHref.textContent = location.href;
    const { uuid, code } = getQuery();
    if (uuid) {
      // start
      console.log('uuid');
      const uuidEl = document.querySelector('#uuid');
      uuidEl.textContent = uuid;
      localStorage.setItem('uuid', uuid);
      const KAKAO_LOGIN_KEY = 'eaca64fa795006e298e348acc14ab691';
      const KAKAO_LOGIN_BRIDGE_URL = 'http://192.168.1.165:5500/public/login/kakao/index.html';
      window.location.href=`https://kauth.kakao.com/oauth/authorize?client_id=${KAKAO_LOGIN_KEY}&redirect_uri=${KAKAO_LOGIN_BRIDGE_URL}&response_type=code`
    }
    if (code) {
      console.log('code');
      const codeEl = document.querySelector('#code');
      codeEl.textContent = code;
      const KAKAO_USER_API_KEY = 'eaca64fa795006e298e348acc14ab691';
      const KAKAO_LOGIN_BRIDGE_URL = 'http://192.168.1.165:5500/public/login/kakao/index.html';
      const checkToken = `https://kauth.kakao.com/oauth/token?grant_type=authorization_code&client_id=${KAKAO_USER_API_KEY}&redirect_uri=${KAKAO_LOGIN_BRIDGE_URL}&code=${code}`;
      axios.get(checkToken)
        .then(({ data }) => loginKakao(data))
        .then(() => { console.log('aaa')})
    }

    function getQuery() {
      return window.location.search.replace('?', '').split('&').reduce((accum, item) => {
        const [key, value] = item.split('=');
        accum[key] = value;
        return accum;
      }, {});
    }

    function loginKakao({ access_token, refresh_token}) {
      const uuid = localStorage.getItem('uuid');
      const body = {
        accessToken: access_token,
        refreshToken: refresh_token,
        uuid
      }
      return axios.post('http://localhost:4040/api/auth/login/kakao', body).then(result => console.log(result));
    }
  </script>
</body>
</html>